using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using Microsoft.Win32;
using TemplateForge.Core;
using TemplateForge.Services;

namespace TemplateForge
{
    /// <summary>
    /// MainWindow.xamlì— ëŒ€í•œ ìƒí˜¸ ì‘ìš© ë…¼ë¦¬
    /// </summary>
    public partial class MainWindow : Window
    {
        private readonly TemplateLoader templateLoader;
        private bool isUpdatingFromTemplate = false;

        public MainWindow()
        {
            InitializeComponent();
            this.templateLoader = new TemplateLoader();
            
            this.Loaded += MainWindow_Loaded;
        }

        private async void MainWindow_Loaded(object sender, RoutedEventArgs e)
        {
            // í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ
            loadTemplates();
            
            // FastMCP ìƒíƒœ ì²´í¬
            await checkFastMcpStatus();
        }

        private void loadTemplates()
        {
            try
            {
                var templates = this.templateLoader.getAvailableTemplates();
                this.TemplateListBox.ItemsSource = templates;
                this.TemplateListBox.DisplayMemberPath = "Name";

                if (templates.Any())
                {
                    this.TemplateListBox.SelectedIndex = 0;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"í…œí”Œë¦¿ ë¡œë“œ ì˜¤ë¥˜: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
        }

        private async Task checkFastMcpStatus()
        {
            try
            {
                if (App.FastMcpClient != null)
                {
                    // ê°„ë‹¨í•œ í—¬ìŠ¤ì²´í¬ (ì‹¤ì œë¡œëŠ” ë³„ë„ API í˜¸ì¶œ)
                    this.StatusIndicator.Fill = new SolidColorBrush(Colors.Green);
                    this.StatusText.Text = "Connected";
                }
                else
                {
                    this.StatusIndicator.Fill = new SolidColorBrush(Colors.Red);
                    this.StatusText.Text = "Disconnected";
                }
            }
            catch
            {
                this.StatusIndicator.Fill = new SolidColorBrush(Colors.Red);
                this.StatusText.Text = "Error";
            }
        }

        private void TemplateListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (this.TemplateListBox.SelectedItem is TemplateInfo selectedTemplate)
            {
                this.isUpdatingFromTemplate = true;
                try
                {
                    //  string ëŒ€ì‹  TemplateInfo ì „ë‹¬
                    var templateContent = this.templateLoader.loadTemplate(selectedTemplate);
                    this.YamlEditor.Text = templateContent;
                    this.updateModuleName(templateContent);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"í…œí”Œë¦¿ ë¡œë“œ ì˜¤ë¥˜: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Warning);
                }
                finally
                {
                    this.isUpdatingFromTemplate = false;
                }
            }
        }


        private void updateModuleName(string yamlContent)
        {
            // ê°„ë‹¨í•œ YAML íŒŒì‹±ìœ¼ë¡œ ëª¨ë“ˆëª… ì¶”ì¶œ
            var lines = yamlContent.Split('\n');
            foreach (var line in lines)
            {
                if (line.Trim().StartsWith("module:"))
                {
                    var moduleName = line.Split(':')[1].Trim().Trim('"');
                    if (!string.IsNullOrEmpty(moduleName) && moduleName != "ëª¨ë“ˆëª…" && moduleName != "MODULE_NAME")
                    {
                        this.ModuleNameTextBox.Text = moduleName;
                        break;
                    }
                }
            }
        }

        private async void Generate_Click(object sender, RoutedEventArgs e)
        {
            if (App.FastMcpClient == null)
            {
                MessageBox.Show("FastMCP ì„œë²„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "Error", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            try
            {
                this.GenerateButton.IsEnabled = false;
                this.GenerateButton.Content = "ìƒì„± ì¤‘...";

                var yamlContent = this.YamlEditor.Text;
                var outputPath = this.OutputPathTextBox.Text;

                // YAMLì—ì„œ ëª¨ë“ˆëª… êµì²´
                yamlContent = replaceModuleName(yamlContent, this.ModuleNameTextBox.Text);

                var response = await App.FastMcpClient.generateProjectAsync(yamlContent, outputPath);

                if (response.success)
                {
                    MessageBox.Show(
                        $"í”„ë¡œì íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
                        $"ëª¨ë“ˆ: {response.module_name}\n" +
                        $"ìƒì„±ëœ í´ë”: {response.created_folders?.Length ?? 0}ê°œ\n" +
                        $"ìœ„ì¹˜: {Path.Combine(outputPath, response.module_name)}",
                        "Success",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);

                    // ìƒì„±ëœ í´ë” ì—´ê¸°
                    var folderPath = Path.Combine(outputPath, response.module_name);
                    if (Directory.Exists(folderPath))
                    {
                        System.Diagnostics.Process.Start("explorer.exe", folderPath);
                    }
                }
                else
                {
                    MessageBox.Show("í”„ë¡œì íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"í”„ë¡œì íŠ¸ ìƒì„± ì˜¤ë¥˜: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
            finally
            {
                this.GenerateButton.IsEnabled = true;
                this.GenerateButton.Content = "ğŸš€ Generate";
            }
        }

        private async void Validate_Click(object sender, RoutedEventArgs e)
        {
            if (App.FastMcpClient == null)
            {
                this.ValidationResults.Text = "FastMCP ì„œë²„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                return;
            }

            try
            {
                var yamlContent = replaceModuleName(this.YamlEditor.Text, this.ModuleNameTextBox.Text);
                var response = await App.FastMcpClient.validateYamlAsync(yamlContent);

                if (response.valid)
                {
                    this.ValidationResults.Text = "âœ… YAML ê²€ì¦ ì„±ê³µ!\n\nìœ íš¨í•œ ëª…ì„¸ì…ë‹ˆë‹¤.";
                    this.ValidationResults.Foreground = new SolidColorBrush(Colors.Green);
                }
                else
                {
                    this.ValidationResults.Text = "âŒ YAML ê²€ì¦ ì‹¤íŒ¨:\n\n" + string.Join("\n", response.errors ?? new string[0]);
                    this.ValidationResults.Foreground = new SolidColorBrush(Colors.Red);
                }
            }
            catch (Exception ex)
            {
                this.ValidationResults.Text = $"âŒ ê²€ì¦ ì˜¤ë¥˜: {ex.Message}";
                this.ValidationResults.Foreground = new SolidColorBrush(Colors.Red);
            }
        }

        private async void Preview_Click(object sender, RoutedEventArgs e)
        {
            await updatePreview();
        }

        private async void YamlEditor_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (this.isUpdatingFromTemplate)
            {
                return;
            }

            // ì‹¤ì‹œê°„ í”„ë¦¬ë·° ì—…ë°ì´íŠ¸ (ë””ë°”ìš´ìŠ¤ ì—†ì´ ê°„ë‹¨í•˜ê²Œ)
            await updatePreview();
        }

        private async Task updatePreview()
        {
            if (App.FastMcpClient == null)
            {
                this.GeneratedFiles.Text = "FastMCP ì„œë²„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                return;
            }

            try
            {
                var yamlContent = this.replaceModuleName(this.YamlEditor.Text, this.ModuleNameTextBox.Text);
                var response = await App.FastMcpClient.previewStructureAsync(yamlContent);

                if (response.success && response.structure != null)
                {
                    var preview = $"ğŸ“ {response.structure.module_name}/\n";
                    foreach (var folder in response.structure.folders ?? Array.Empty<string>()) { preview += $"â”œâ”€â”€ ğŸ“ {folder}/\n"; }
                    foreach (var file in response.structure.files ?? Array.Empty<string>()) { preview += $"â”œâ”€â”€ ğŸ“„ {file}\n"; }

                    this.GeneratedFiles.Text = preview;
                    this.GeneratedFiles.Foreground = new SolidColorBrush(Colors.Black);
                }
                else
                {
                    this.GeneratedFiles.Text = "êµ¬ì¡°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    this.GeneratedFiles.Foreground = new SolidColorBrush(Colors.Gray);
                }
            }
            catch (Exception ex)
            {
                this.GeneratedFiles.Text = $"ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: {ex.Message}";
                this.GeneratedFiles.Foreground = new SolidColorBrush(Colors.Red);
            }
        }


        private string replaceModuleName(string yamlContent, string newModuleName)
        {
            // ê°„ë‹¨í•œ ëª¨ë“ˆëª… êµì²´
            return yamlContent
                .Replace("module: ëª¨ë“ˆëª…", $"module: {newModuleName}")
                .Replace("module: MODULE_NAME", $"module: {newModuleName}");
        }

        private void BrowseOutputPath_Click(object sender, RoutedEventArgs e)
        {
            using (var dialog = new System.Windows.Forms.FolderBrowserDialog())
            {
                dialog.Description = "ì¶œë ¥ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
                dialog.ShowNewFolderButton = true;
                var result = dialog.ShowDialog();
                if (result == System.Windows.Forms.DialogResult.OK && !string.IsNullOrWhiteSpace(dialog.SelectedPath))
                {
                    this.OutputPathTextBox.Text = dialog.SelectedPath;
                }
            }
        }

    }
}
