using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection;

namespace TemplateForge.Core
{
    public sealed class TemplateLoader
    {
        private readonly List<TemplateInfo> builtInTemplates;
        private readonly List<TemplateInfo> importedTemplates;

        public TemplateLoader()
        {
            this.builtInTemplates = new List<TemplateInfo>();
            this.importedTemplates = new List<TemplateInfo>();
            this.loadBuiltInTemplates();
        }

        // âœ… MainWindow ìª½ì—ì„œ í˜¸ì¶œí•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë§ì¶¤
        public IReadOnlyList<TemplateInfo> getAvailableTemplates()
        {
            return this.getAllTemplates();
        }

        public IReadOnlyList<TemplateInfo> getAllTemplates()
        {
            var allTemplates = new List<TemplateInfo>();
            allTemplates.AddRange(this.builtInTemplates);
            allTemplates.AddRange(this.importedTemplates);

            return new ReadOnlyCollection<TemplateInfo>(
                allTemplates
                    .OrderBy(t => t.getCategory(), StringComparer.Ordinal)
                    .ThenBy(t => t.getName(), StringComparer.Ordinal)
                    .ToList()
            );
        }

        // âœ… ì˜¤ë²„ë¡œë“œ ì¶”ê°€: string íŒŒì¼ëª…ìœ¼ë¡œë„ ë¡œë“œ ê°€ëŠ¥
        public string loadTemplate(string fileName)
        {
            if (string.IsNullOrWhiteSpace(fileName))
            {
                throw new ArgumentException("fileName is null or empty.");
            }
            var info = this.builtInTemplates.FirstOrDefault(t => string.Equals(t.FileName, fileName, StringComparison.OrdinalIgnoreCase))
                       ?? this.importedTemplates.FirstOrDefault(t => string.Equals(t.FileName, fileName, StringComparison.OrdinalIgnoreCase));

            if (info == null)
            {
                throw new FileNotFoundException($"Template not found: {fileName}");
            }
            return this.loadTemplate(info);
        }

        public string loadTemplate(TemplateInfo templateInfo)
        {
            if (templateInfo == null)
            {
                throw new ArgumentNullException(nameof(templateInfo));
            }

            if (templateInfo.IsBuiltIn)
            {
                return this.loadBuiltInTemplate(templateInfo.FileName);
            }
            else
            {
                return File.ReadAllText(templateInfo.FilePath, System.Text.Encoding.UTF8);
            }
        }

        public void importTemplate(string filePath)
        {
            if (!File.Exists(filePath))
            {
                throw new FileNotFoundException($"í…œí”Œë¦¿ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {filePath}");
            }

            var fileNameNoExt = Path.GetFileNameWithoutExtension(filePath);
            var templateInfo = this.createImportedTemplateInfo(fileNameNoExt, filePath);

            var existing = this.importedTemplates.FirstOrDefault(t =>
                t.FileName.Equals(templateInfo.FileName, StringComparison.OrdinalIgnoreCase));

            if (existing != null)
            {
                this.importedTemplates.Remove(existing);
            }

            this.importedTemplates.Add(templateInfo);
        }

        public void removeImportedTemplate(TemplateInfo templateInfo)
        {
            if (templateInfo == null) { return; }
            this.importedTemplates.Remove(templateInfo);
        }

        private void loadBuiltInTemplates()
        {
            this.builtInTemplates.Add(new TemplateInfo("ëª¨ë“ˆ ëª…ì„¸ (ê¸°ë³¸)", "ğŸ“‹ Module", "í•œêµ­ì–´", "module-basic-ko.yaml", null, true, true, "ë‹¨ì¼ ëª¨ë“ˆì˜ API, ì´ë²¤íŠ¸, ì œì•½ì‚¬í•­ ì •ì˜"));
            this.builtInTemplates.Add(new TemplateInfo("Module Spec (Basic)", "ğŸ“‹ Module", "English", "module-basic-en.yaml", null, false, true, "Define API, events, and constraints for a single module"));
            this.builtInTemplates.Add(new TemplateInfo("ì•± êµ¬ì„± (ê¸°ë³¸)", "ğŸ¢ App Composition", "í•œêµ­ì–´", "app-composition-ko.yaml", null, true, true, "ì „ì—­ DI, ìˆ˜ëª…ì£¼ê¸°, ì´ë²¤íŠ¸ ë¼ìš°íŒ… ì„¤ì •"));
        }

        private string loadBuiltInTemplate(string fileName)
        {
            var asm = Assembly.GetExecutingAssembly();

            // âœ… ì‹¤ì œ ë‚´ì¥ ë¦¬ì†ŒìŠ¤ ì´ë¦„ í™•ì¸ (ë””ë²„ê¹…ì— ìœ ìš©)
            // var names = asm.GetManifestResourceNames(); // í•„ìš”ì‹œ í™•ì¸

            // ê¸°ë³¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” í”„ë¡œì íŠ¸ì˜ Default Namespaceì™€ ì¼ì¹˜í•´ì•¼ í•¨
            var resourceName = $"TemplateForge.Resources.Templates.{fileName}";
            using (var stream = asm.GetManifestResourceStream(resourceName))
            {
                if (stream != null)
                {
                    using (var reader = new StreamReader(stream))
                    {
                        return reader.ReadToEnd();
                    }
                }
            }

            // íŒŒì¼ ì‹œìŠ¤í…œ í´ë°±
            var filePath = Path.Combine(Path.GetDirectoryName(asm.Location) ?? AppDomain.CurrentDomain.BaseDirectory,
                                        "Resources", "Templates", fileName);
            if (File.Exists(filePath))
            {
                return File.ReadAllText(filePath, System.Text.Encoding.UTF8);
            }

            throw new FileNotFoundException($"ë‚´ì¥ í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {fileName}");
        }

        private TemplateInfo createImportedTemplateInfo(string fileNameNoExt, string filePath)
        {
            var category = this.detectCategory(fileNameNoExt);
            var isKorean = fileNameNoExt.EndsWith("-ko", StringComparison.OrdinalIgnoreCase)
                           || fileNameNoExt.Contains("í•œê¸€", StringComparison.OrdinalIgnoreCase)
                           || fileNameNoExt.Contains("kr", StringComparison.OrdinalIgnoreCase);

            var language = isKorean ? "í•œêµ­ì–´" : "English";
            var displayName = this.formatDisplayName(fileNameNoExt, isKorean);
            var categoryIcon = this.getCategoryIcon(category);

            return new TemplateInfo(
                name: displayName,
                category: categoryIcon + " " + category,
                language: language,
                fileName: Path.GetFileName(filePath),
                filePath: filePath,
                isKorean: isKorean,
                isBuiltIn: false,
                description: this.generateDescription(fileNameNoExt, isKorean)
            );
        }

        private string detectCategory(string fileNameNoExt)
        {
            if (fileNameNoExt.IndexOf("module", StringComparison.OrdinalIgnoreCase) >= 0) { return "Module"; }
            if (fileNameNoExt.IndexOf("app", StringComparison.OrdinalIgnoreCase) >= 0
                || fileNameNoExt.IndexOf("composition", StringComparison.OrdinalIgnoreCase) >= 0) { return "App Composition"; }
            if (fileNameNoExt.IndexOf("system", StringComparison.OrdinalIgnoreCase) >= 0) { return "System"; }
            if (fileNameNoExt.IndexOf("integration", StringComparison.OrdinalIgnoreCase) >= 0) { return "Integration"; }
            if (fileNameNoExt.IndexOf("data", StringComparison.OrdinalIgnoreCase) >= 0
                || fileNameNoExt.IndexOf("pipeline", StringComparison.OrdinalIgnoreCase) >= 0) { return "Data Pipeline"; }
            if (fileNameNoExt.IndexOf("migration", StringComparison.OrdinalIgnoreCase) >= 0) { return "Migration"; }
            if (fileNameNoExt.IndexOf("monitoring", StringComparison.OrdinalIgnoreCase) >= 0) { return "Monitoring"; }
            if (fileNameNoExt.IndexOf("test", StringComparison.OrdinalIgnoreCase) >= 0) { return "Testing"; }

            return "Custom";
        }

        private string getCategoryIcon(string category)
        {
            switch (category)
            {
                case "Module": return "ğŸ“‹";
                case "App Composition": return "ğŸ¢";
                case "System": return "ğŸ–¥ï¸";
                case "Integration": return "ğŸ”—";
                case "Data Pipeline": return "ğŸ“Š";
                case "Migration": return "ğŸ”„";
                case "Monitoring": return "ğŸ“ˆ";
                case "Testing": return "ğŸ§ª";
                default: return "ğŸ“„";
            }
        }

        private string formatDisplayName(string fileNameNoExt, bool isKorean)
        {
            var name = fileNameNoExt
                .Replace("-template", "", StringComparison.OrdinalIgnoreCase)
                .Replace("template-", "", StringComparison.OrdinalIgnoreCase)
                .Replace("-ko", "", StringComparison.OrdinalIgnoreCase)
                .Replace("-en", "", StringComparison.OrdinalIgnoreCase)
                .Replace("-", " ", StringComparison.Ordinal)
                .Replace("_", " ", StringComparison.Ordinal);

            if (!string.IsNullOrEmpty(name))
            {
                name = char.ToUpper(name[0], CultureInfo.InvariantCulture) + name.Substring(1);
            }

            return string.IsNullOrEmpty(name) ? "Imported Template" : name;
        }

        private string generateDescription(string fileNameNoExt, bool isKorean)
        {
            if (fileNameNoExt.IndexOf("module", StringComparison.OrdinalIgnoreCase) >= 0)
            {
                return isKorean ? "ëª¨ë“ˆ ëª…ì„¸ í…œí”Œë¦¿" : "Module specification template";
            }
            if (fileNameNoExt.IndexOf("app", StringComparison.OrdinalIgnoreCase) >= 0
                || fileNameNoExt.IndexOf("composition", StringComparison.OrdinalIgnoreCase) >= 0)
            {
                return isKorean ? "ì•± êµ¬ì„± í…œí”Œë¦¿" : "Application composition template";
            }
            return isKorean ? "ì„í¬íŠ¸ëœ í…œí”Œë¦¿" : "Imported template";
        }
    }

    public sealed class TemplateInfo
    {
        // WPF ë°”ì¸ë”©ì„ ìœ„í•´ì„œëŠ” í”„ë¡œí¼í‹° ìœ ì§€ + ë©”ì„œë“œí˜• getterë„ ë³‘í–‰
        public string Name { get; set; }
        public string Category { get; set; }
        public string Language { get; set; }
        public string FileName { get; set; }
        public string FilePath { get; set; }
        public bool IsKorean { get; set; }
        public bool IsBuiltIn { get; set; }
        public string Description { get; set; }

        public TemplateInfo() { }

        public TemplateInfo(string name, string category, string language, string fileName, string filePath, bool isKorean, bool isBuiltIn, string description)
        {
            this.Name = name;
            this.Category = category;
            this.Language = language;
            this.FileName = fileName;
            this.FilePath = filePath;
            this.IsKorean = isKorean;
            this.IsBuiltIn = isBuiltIn;
            this.Description = description;
        }

        public string getName() { return this.Name; }
        public string getCategory() { return this.Category; }
        public string getLanguage() { return this.Language; }
        public string getFileName() { return this.FileName; }
        public string getFilePath() { return this.FilePath; }
        public bool getIsKorean() { return this.IsKorean; }
        public bool getIsBuiltIn() { return this.IsBuiltIn; }
        public string getDescription() { return this.Description; }

        public string getDisplayText() { return $"{this.Name} ({this.Language})"; }

        public string getTooltipText()
        {
            var source = this.IsBuiltIn ? "ë‚´ì¥" : "ì„í¬íŠ¸";
            return $"{this.Description}\n\nì†ŒìŠ¤: {source}\níŒŒì¼: {this.FileName}";
        }
    }
}
